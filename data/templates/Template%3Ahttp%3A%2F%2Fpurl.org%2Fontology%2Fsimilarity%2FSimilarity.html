<div id="similarity-template"> 
  <semantic-query
    query=" SELECT DISTINCT ?element ?subject1 ?subject1Link ?subject2 ?subject2Link ?providerA ?providerB ?providerLabelA ?providerLabelB ?imageA ?imageB WHERE {
      ?imageA <http://purl.org/ontology/similarity/element> ??.
      ?imageB <http://purl.org/ontology/similarity/element> ??.
      ?subject1 <https://pharos.artresearch.net/custom/has_image> ?imageA.
      ?subject2 <https://pharos.artresearch.net/custom/has_image> ?imageB.
      ?subject1 <https://pharos.artresearch.net/custom/has_provider> ?providerA.
      ?providerA rdfs:label ?providerLabelA.
      ?subject2 <https://pharos.artresearch.net/custom/has_provider> ?providerB.
      ?providerB rdfs:label ?providerLabelB.
      BIND (STR(?subject1) as ?subject1Link)
      BIND (STR(?subject2) as ?subject2Link)
      BIND (?? as ?element)
      FILTER (STR(?imageA)!=STR(?imageB))
     
  } Limit 1"
    template="{{>matchingTemplate}}"
  >
    <template id="matchingTemplate">
      <div class="instanceMatchingPage">
        <!-- Photos & similarity information -->
          <div class="SimilarityWrapper">
                          <semantic-query
              query='SELECT DISTINCT ?element ?subject1 ?subject2  ?imageA ?imageB ?thumbA ?thumbB WHERE{
                        <{{bindings.0.subject1.value}}>  <https://pharos.artresearch.net/custom/has_image> ?imageA.
                        BIND(REPLACE(STR(?imageA),"full/full","full/!150,150") AS ?thumbA).
                        <{{bindings.0.subject2.value}}>  <https://pharos.artresearch.net/custom/has_image> ?imageB.
                        BIND(REPLACE(STR(?imageB),"full/full","full/!150,150") AS ?thumbB).
                        ?imageA <http://purl.org/ontology/similarity/element> ?element.
                        ?imageB <http://purl.org/ontology/similarity/element> ?element.
                    }'
              template="{{>imageAthumbs}}"
            >
              <template id="imageAthumbs">
                {{#ifCond (objectLength bindings) ">" 0}}
                
                <div class="imageFlex">

                    {{#each bindings}}
                    <mp-event-trigger
                      id="event-trigger-image-a"
                      type="Component.TemplateUpdate"
                      data='{"element":"{{element.value}}","imageA":"{{imageA.value}}","imageB":"{{imageB.value}}"}'
                      targets='["large-image-display"]'
                    >
                      <div class="thumbPairContainer">                  
                        <img class="smallThumbsSingle" src="{{thumbA.value}}" />
                        <img class="smallThumbsSingle" src="{{thumbB.value}}" />
                      </div>
                    </mp-event-trigger>
                    {{/each}}
                  </div>
                  {{/ifCond}}
              </template>
            </semantic-query>
            <div class="pharosFieldViewer">
                <mp-event-target-template-render
                  id="large-image-display"
                  template="{{> largeImageDisplay}}"
                >
                  <template id="largeImageDisplay">
                    {{#ifCond imageA "&&" imageB}} 
                        [[> rsp:MatchingCanditateImages element="{{element}}" imageA="{{imageA}}" imageB="{{imageB}}"]] 
                    {{else}} 
                        [[> rsp:MatchingCanditateImages element="{{bindings.0.element.value}}" imageA="{{bindings.0.imageA.value}}" imageB="{{bindings.0.imageB.value}}"]]
                    {{/ifCond}}
                  </template>
                </mp-event-target-template-render>
                  
              </div>


          </div>
          <small style="position: absolute; left: 5vw; top: 2vh;">Click on the pairs to view photo similarities</small>
       <h3 style="position: relative; width: 70%; left: -10%;">View more photos from artworks</h3>
      <div class="PanelWrapper">
     <div class="WrapperCarousel">
            <bs-col class="cardInfo inWrap" lg="2" xs="10">
              [[> :SimilarityListThumbnails iri="{{bindings.0.subject1.value}}"]]
            </bs-col>
              <bs-col class="cardInfo inWrap" lg="2" xs="10">
              [[> :SimilarityListThumbnails iri="{{bindings.0.subject2.value}}"]]
            </bs-col>
           </div>     
   
    </div>

        <div class="matchContainer">
          <!-- Matching candidates fields comparison table -->
          <div class="fieldViewer">[[> rsp:MatchingCanditateFields]]</div>
        </div>
        <p></p>
        <p></p>
        [[#if (ask "ASK WHERE { ?? <https://vision.artresearch.net/custom/reviewed> true}")]]
          <div class="sidebar reviewed-box">
            {{bindings.0.modifiedAt.value}}
            <h2>This matching has been reviewed</h2>
            <semantic-query
              query='SELECT DISTINCT ?attribution (SAMPLE(?modifiedAt) AS ?modifiedAt)  WHERE {
                GRAPH ?g {
                  <http://www.researchspace.org/resource/system/formContainer> <http://www.w3.org/ns/ldp#contains> ?subject. 
                  ?subject <http://www.w3.org/ns/prov#generatedAtTime> ?modifiedAt ; 
                            <http://www.w3.org/ns/prov#wasAttributedTo> ?attribution.
                  ?? <https://vision.artresearch.net/custom/reviewed> true
                }
              } GROUP BY ?attribution'
                template="{{>reviewedMatching}}"
            >
            <template id="reviewedMatching">
                {{#each bindings}}
                  <h2>by <mp-label iri='{{attribution.value}}'></mp-label></h2>
                  <h2>at {{modifiedAt.value}}</h2>
                {{/each}}
              </template>
          </semantic-query>
          </div>
        [[else]]
          {{#if '[[urlParam "providera"]]'}}
            <div class="sidebar">
              <semantic-query
                query='SELECT ?nextElement  
                              (<{{bindings.0.element.value}}> AS ?element) 
                              (<{{bindings.0.subject1.value}}> AS ?subject1)
                              (<{{bindings.0.subject2.value}}> AS ?subject2) WHERE {
                        ?subject1_next <https://pharos.artresearch.net/custom/has_provider> <[[urlParam "providera"]]>;
                          <https://pharos.artresearch.net/custom/has_image> ?imageA_next.
                        ?subject2_next <https://pharos.artresearch.net/custom/has_provider> <[[urlParam "providerb"]]>;
                          <https://pharos.artresearch.net/custom/has_image> ?imageB_next.
                        ?imageA_next <http://purl.org/ontology/similarity/element> ?nextElement.
                        ?imageB_next <http://purl.org/ontology/similarity/element> ?nextElement.
                        FILTER NOT EXISTS { ?nextElement <https://vision.artresearch.net/custom/reviewed> "true"^^xsd:boolean }
                        FILTER NOT EXISTS { ?nextElement <https://vision.artresearch.net/custom/skipped> "true"^^xsd:boolean }
                        {
                          SELECT (GROUP_CONCAT(distinct ?sim) as ?sims) WHERE {
                            <{{bindings.0.subject1.value}}> <https://pharos.artresearch.net/custom/has_image> ?imgA2.
                            <{{bindings.0.subject2.value}}> <https://pharos.artresearch.net/custom/has_image> ?imgB2.
                            ?imgA2 <http://purl.org/ontology/similarity/element> ?sim.
                            ?imgB2 <http://purl.org/ontology/similarity/element> ?sim.
                          }
                        }
                        FILTER (!(CONTAINS(?sims, STR(?nextElement))))
                    }LIMIT 1'
                template="{{>imageInfoTemplate}}"
                no-result-template="{{>noNextSimilarity}}"
              >
                <template id="imageInfoTemplate">
                  [[> :Sidebar]]
                </template>

                <template id="noNextSimilarity">
                  <semantic-query
                    query=' SELECT ?element ?nextElement ?subject1 ?subject2 WHERE {
                            BIND(Default:SimilarityList as ?nextElement)
                            BIND(<{{bindings.0.subject1.value}}> AS ?subject1)
                            BIND(<{{bindings.0.subject2.value}}> AS ?subject2)
                            BIND (<{{bindings.0.element.value}}> AS ?element)
                        }LIMIT 1'
                    template="{{>sidebarWithNoNext}}"
                  >
                    <template id="sidebarWithNoNext">
                      [[> :Sidebar]]
                    </template>
                  </semantic-query>
                </template>
              </semantic-query>
            </div>
          {{/if}}
        [[/if]]
      </div>
    </template>
  </semantic-query>
</div>
<style>

  #similarity-template .semantic-form {
  margin: unset !important;
  border-radius: 5px !important;
}
  #similarity-template .semantic-form:hover {
  margin: unset !important;
  box-shadow:0px 0px 10px 1px #383838;
}
.semantic-form button[name=cancel], .semantic-form button[name=delete], .semantic-form button[name=reset], .semantic-form button[name=submit]{
  margin-left:unset !important;
  border-radius: 5px;
}
.skip{
  background: #a5a5a5 !important;
}
.forms-in-a-row{
  padding-top:20px !important;
}
.Label-value{
    padding-left: 20px;
    display: flex;
    font-weight: bold;
    padding-bottom: 10px;
}

.selectionWrapper{
    display: flex;
    flex-direction: row-reverse;
}
.panel-heading{
  background-color: white !important;
}
.PanelWrapper{
  border-top: 1px solid grey;
   border-bottom: 1px solid grey;
    justify-content: flex-start;
    align-items: center;
    flex-wrap: wrap;
    position: relative;
    left: -10%;
    width: 70%;
    display: flex;
    padding: 10px;
}

.panel.panel-default{
width: 80% !important;
}
</style>

